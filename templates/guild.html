{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2 style="margin-top:0">Guild {{ guild_id }}</h2>
  <div class="row">
    <div class="col">
      <h3>Configuration</h3>
      <form method="post" action="/guild/{{ guild_id }}/config">
        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        <label>Support Channel ID</label>
        <input type="number" name="support_channel_id" value="{{ (config.support_channel_id if config else '') }}">
        <label>Ticket Parent Category ID</label>
        <input type="number" name="ticket_category_id" value="{{ (config.ticket_category_id if config else '') }}">
        <label>Staff Role ID</label>
        <input type="number" name="staff_role_id" value="{{ (config.staff_role_id if config else '') }}">
        <label>Panel Title</label>
        <input type="text" name="panel_title" value="{{ (config.panel_title if config else '') }}">
        <label>Panel Description</label>
        <textarea name="panel_description" rows="4">{{ (config.panel_description if config else '') }}</textarea>
        <label>Contact Name</label>
        <input type="text" name="contact_name" value="{{ (config.contact_name if config else '') }}">
        <label>Allow User Close (1/0)</label>
        <input type="number" min="0" max="1" name="allow_user_close" value="{{ (config.allow_user_close if config else 1) }}">
        <div style="margin-top:12px"><button type="submit">Save Config</button></div>
      </form>
    </div>
    <div class="col">
      <h3>Add Category</h3>
      <form method="post" action="/guild/{{ guild_id }}/categories/add">
        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        <label>Name</label>
        <input type="text" name="name" required>
        <label>Placeholder (optional)</label>
        <input type="text" name="placeholder">
        <div style="margin-top:12px"><button type="submit">Add</button></div>
      </form>
    </div>
  </div>
</div>

<div class="card">
  <h3 style="margin-top:0">Categories</h3>
  {% if categories and categories|length > 0 %}
  {% for c in categories %}
    <div class="card">
      <div class="row">
        <div class="col">
          <h4 style="margin:0">{{ c.name }} <small>(id: {{ c.id }})</small></h4>
          {% if c.placeholder %}<p><small>Placeholder: {{ c.placeholder }}</small></p>{% endif %}
        </div>
        <div class="col" style="text-align:right">
          <form method="post" action="/guild/{{ guild_id }}/categories/{{ c.id }}/remove" onsubmit="return confirm('Deactivate this category?')">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
            <button class="btn btn-danger" type="submit">Deactivate</button>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <h5>Fields</h5>
          {% set fields = cat_fields.get(c.id, []) %}
          {% if fields and fields|length > 0 %}
          <table>
            <thead><tr><th>Label</th><th>Name</th><th>Required</th><th>Style</th><th>Length</th><th></th></tr></thead>
            <tbody>
              {% for f in fields %}
              <tr>
                <td>{{ f.label }}</td>
                <td>{{ f.name }}</td>
                <td>{{ 'Yes' if f.required else 'No' }}</td>
                <td>{{ f.style }}</td>
                <td>{{ f.min_length or '' }}{% if f.max_length %}â€“{{ f.max_length }}{% endif %}</td>
                <td>
                  <form method="post" action="/guild/{{ guild_id }}/fields/{{ f.id }}/remove" onsubmit="return confirm('Remove this field?')">
                    <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                    <button class="btn btn-danger" type="submit">Remove</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
            <p><small>No fields configured.</small></p>
          {% endif %}
        </div>
        <div class="col">
          <h5>Add Field</h5>
          <form method="post" action="/guild/{{ guild_id }}/categories/{{ c.id }}/fields/add">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
            <label>Name</label>
            <input type="text" name="name" required>
            <label>Label</label>
            <input type="text" name="label" required>
            <label>Required</label>
            <input type="checkbox" name="required" checked>
            <label>Style</label>
            <select name="style">
              <option value="short">short</option>
              <option value="paragraph">paragraph</option>
            </select>
            <label>Min Length</label>
            <input type="number" name="min_length" min="0">
            <label>Max Length</label>
            <input type="number" name="max_length" min="1">
            <div style="margin-top:12px"><button type="submit">Add Field</button></div>
          </form>
        </div>
      </div>
    </div>
  {% endfor %}
  {% else %}
    <p>No active categories.</p>
  {% endif %}
</div>

<div class="card">
  <a class="btn btn-secondary" href="/guild/{{ guild_id }}/tickets">View recent tickets</a>
  <p><small>Only last 100 tickets are shown here for brevity.</small></p>
</div>
{% endblock %}

